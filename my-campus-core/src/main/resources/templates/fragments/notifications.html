<div th:fragment="notifications">

    <div class="dropdown position-relative">
        <!-- Notification Icon -->
        <button class="btn btn-link text-dark p-0 position-relative" type="button" id="notificationDropdownButton"
            data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-bell fs-4"></i>
            <span id="notificationBadge" class="position-absolute badge rounded-circle bg-danger border border-white"
                style="width: 12px; height: 12px; top: 5%; right: 5%; transform: translate(-5%, 25%); padding: 0; font-size: 1;">

            </span>
        </button>

        <!-- Dropdown Menu -->
        <ul class="dropdown-menu dropdown-menu-end p-0" style="width: 300px; max-height: 400px; overflow-y: auto;"
            aria-labelledby="notificationDropdownButton">
            <li>
                <div class="p-2 border-bottom bg-light">
                    <h6 class="mb-0 text-dark">Notifications</h6>
                </div>
            </li>
            <li id="notificationsContainer">
                <div class="p-3 text-center text-muted">
                    Loading notifications...
                </div>
            </li>
        </ul>
    </div>

    <script>
        function handleNotificationHover(element) {
            const notificationId = element.getAttribute('data-id');

            // Only proceed if the notification is unread (optional)
            if (element.style.backgroundColor === 'rgb(240, 240, 240)') {
                // Make POST request
                fetch(`http://localhost:8082/api/notification/v1/status/${notificationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            // Update UI to show it's read
                            element.style.backgroundColor = '#FFFFFF';
                            const badgeElement = document.getElementById("notificationBadge");
                         
                                const currentValue = Number(badgeElement.textContent);
                                console.log("currentValue: "+currentValue)
                                if (!isNaN(currentValue)) {
                                    badgeElement.textContent = currentValue - 1;
                                }
                            


                        }
                    })
                    .catch(error => {
                        console.error('Error updating notification status:', error);
                    });
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            const userId = 2;
            const badge = document.getElementById('notificationBadge');
            const container = document.getElementById('notificationsContainer');



            // Make the API call
            fetch(`http://localhost:8082/api/notification/v1/${userId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Notification API response:', data);
                    updateNotifications(data);
                })
                .catch(error => {
                    console.error('Error fetching notifications:', error);
                    container.innerHTML = `
                        <div class="p-3 text-center text-muted">
                            Failed to load notifications
                        </div>
                    `;
                });

            function updateNotifications(notifications) {
                if (!notifications || notifications.length === 0) {
                    container.innerHTML = `
                        <div class="p-3 text-center text-muted">
                            No new notifications
                        </div>
                    `;
                    badge.style.display = 'none';
                    return;
                }
                let unreadNotifications = notifications.filter(notification => notification.status != "READ");
                // Update badge
                badge.textContent = unreadNotifications.length;
                badge.style.display = 'block';

                // Update dropdown content
                let html = '';
                notifications.forEach(notification => {
                    html += `
                                <li>
                                    <div class="px-3 py-2 border-bottom notification-item" 
                                        style="background-color:${notification.status === "READ" ? '#FFFFFF' : '#F0F0F0'};"
                                        data-id="${notification.id}"
                                        onclick="handleNotificationHover(this)">
                                        <p class="mb-0 text-dark">${notification.message || 'New notification'}</p>
                                    </div>
                                </li>
                            `;
                });

                container.innerHTML = html;
            }



        });
    </script>

</div>